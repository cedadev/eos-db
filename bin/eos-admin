#!python

"""EOS Admin - Administrator Actions for EOS Cloud

Permissible instructions:

eos-admin adduser <username> <password> :
    Add a user with the specified password.

eos-admin addvm <username> <server_name> <server_uuid> :
    Add a particular server to a user's account.

eos-admin addcredit <username> <credit> :
    Add credit to a user. Negative amounts deduct credit.

eos-admin changepwd <username> <password> :
    Change a user's password.

"""

from __future__ import absolute_import, division, print_function
import sys
from eos_db import server

arg = sys.argv[1:]

if len(arg) == 0:
    print ('No arguments provided. Please type "eos-admin help" for more info.')
    sys.exit()

if arg[0] == 'adduser':
    print ("Adding user...")

    try:
        username = arg[1]
        password = arg[2]
        realname = arg[3] if len(arg) >= 4 else username
    except IndexError:
        print ("Please ensure you enter a username and password.")
        sys.exit()

    server.choose_engine("PostgreSQL")
    id = server.create_user("user", username, realname, username)
    print ("New user created with id %s" % id)
    server.touch_to_add_password(id, password)

elif arg[0] == 'addvm':
    print ("Adding vm...")

    try:
        username = arg[1]
        machine_name = arg[2]
        machine_uuid = arg[3]
    except IndexError:
        print ("Please ensure you enter a username, machine name, and UUID.")
        sys.exit()

    server.choose_engine("PostgreSQL")
    id = server.create_appliance(machine_name, machine_uuid)
    user_id = server.get_user_id_from_name(username)
    id = server.touch_to_add_ownership(id, user_id)
    print ("New server created with id %s" % id)
    print ("New server ownership added to user id %s" % user_id)

elif arg[0] == 'addcredit': #TODO
    if arg[1]:
        username = arg[1]
    else:
        print ("No username specified.")
        sys.exit()
    if arg[2]:
        password = arg[2]
    else:
        print ("No credit amount specified.")
        sys.exit()

elif arg[0] == 'changepwd': #TODO
    if arg[1]:
        username = arg[1]
    else:
        print ("No username specified.")
        sys.exit()
    if arg[2]:
        password = arg[2]
    else:
        print ("No password specified.")
        sys.exit()

else:
    print ("""
EOS Admin - Administrator Actions for EOS Cloud
-----------------------------------------------

    Permissible instructions:

    eos-admin help
        Display this help.

    eos-admin adduser <username> <password>
        Add a user with the specified password.

    eos-admin addvm <username> <server_name> <server_uuid>
        Add a particular server to a user's account.

    eos-admin addcredit <username> <credit>
        Add credit to a user. Negative amounts deduct credit.

    eos-admin changepwd <username> <password>
        Change a user's password.""")
